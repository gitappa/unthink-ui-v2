name: CI sammoon
on:
  push:
    branches: 
      - master
  workflow_dispatch:

jobs:
  build:
    name: Cloud Run Deployment Prod
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: "--max_old_space_size=4096"
      NEXT_PUBLIC_BACKEND_URL: "https://webbot-image-sync-314035436999.us-central1.run.app"
      NEXT_PUBLIC_ACCESS_KEY: "e191921352124a06a09bb811a86a5c3a"
      NEXT_PUBLIC_STAGING_ENV: "false"
      NEXT_PUBLIC_IS_KIOSK_ENABLED: "false"
      NEXT_PUBLIC_SUPER_ADMIN_USER_NAME: "sammoon"
      NEXT_PUBLIC_AURA_HEADER_THEME: "light"
      NEXT_PUBLIC_SHARED_PROFILE_ON_ROOT: "sammoon"
      NEXT_PUBLIC_CURRENT_STORE_NAME: "sammoon"
      NEXT_PUBLIC_CURRENT_STORE_ID: "85244371"
      NEXT_PUBLIC_ENABLE_VIEW_SIMILAR_PRODUCTS: "false"
      NEXT_PUBLIC_ENABLE_RECOMMENDATIONS: "false"
      NEXT_PUBLIC_IS_STORE_INSTANCE: "true"
      NEXT_PUBLIC_ADMIN_USER_ID: "175740324773435"
      NEXT_PUBLIC_AURA_YFRET_USER_COLL_BASE_URL: "https://auraprod.unthink.ai"
      NEXT_PUBLIC_ENABLE_VENLY: "false"
      NEXT_PUBLIC_WEBBOT_NFT_SERVICE__BASE_URL: ""
      NEXT_PUBLIC_PDP_PAGE_ENABLED: "false"
      NEXT_PUBLIC_PAYMENT_URL: "https://unthink-dropp-payment-prod-314035436999.us-central1.run.app"
    steps:
      - name: Checkout
        uses: actions/checkout@main
      - name: Use Node.js 12.x
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}
      - name: Install Dependency
        working-directory: "packages/web-client-next"
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm install --legacy-peer-deps
      - name: Setup and run build on app
        working-directory: "packages/web-client-next"
        run: npm run build
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.DEV_GCP_SA_KEY }}

      - name: Install gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.DEV_GCP_PROJECT_ID }}
      
      - name: Authorize
        #working-directory: "packages/web-client-next"
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
      
      - name: Build
        run: |
          docker build \
          --tag us-central1-docker.pkg.dev/${{ secrets.DEV_GCP_PROJECT_ID }}/unthink-ui-v2/unthink-ui-next-sammoon-ui-v2 \
          --build-arg NEXT_PUBLIC_BACKEND_URL=${{ env.NEXT_PUBLIC_BACKEND_URL }} \
          --build-arg NEXT_PUBLIC_ACCESS_KEY=${{ env.NEXT_PUBLIC_ACCESS_KEY }} \
          --build-arg NEXT_PUBLIC_STAGING_ENV=${{ env.NEXT_PUBLIC_STAGING_ENV }} \
          --build-arg NEXT_PUBLIC_IS_KIOSK_ENABLED=${{ env.NEXT_PUBLIC_IS_KIOSK_ENABLED }} \
          --build-arg NEXT_PUBLIC_SUPER_ADMIN_USER_NAME=${{ env.NEXT_PUBLIC_SUPER_ADMIN_USER_NAME }} \
          --build-arg NEXT_PUBLIC_AURA_HEADER_THEME=${{ env.NEXT_PUBLIC_AURA_HEADER_THEME }} \
          --build-arg NEXT_PUBLIC_SHARED_PROFILE_ON_ROOT=${{ env.NEXT_PUBLIC_SHARED_PROFILE_ON_ROOT }} \
          --build-arg NEXT_PUBLIC_CURRENT_STORE_NAME=${{ env.NEXT_PUBLIC_CURRENT_STORE_NAME }} \
          --build-arg NEXT_PUBLIC_CURRENT_STORE_ID=${{ env.NEXT_PUBLIC_CURRENT_STORE_ID }} \
          --build-arg NEXT_PUBLIC_ENABLE_VIEW_SIMILAR_PRODUCTS=${{ env.NEXT_PUBLIC_ENABLE_VIEW_SIMILAR_PRODUCTS }} \
          --build-arg NEXT_PUBLIC_ENABLE_RECOMMENDATIONS=${{ env.NEXT_PUBLIC_ENABLE_RECOMMENDATIONS }} \
          --build-arg NEXT_PUBLIC_IS_STORE_INSTANCE=${{ env.NEXT_PUBLIC_IS_STORE_INSTANCE }} \
          --build-arg NEXT_PUBLIC_ADMIN_USER_ID=${{ env.NEXT_PUBLIC_ADMIN_USER_ID }} \
          --build-arg NEXT_PUBLIC_AURA_YFRET_USER_COLL_BASE_URL=${{ env.NEXT_PUBLIC_AURA_YFRET_USER_COLL_BASE_URL }} \
          --build-arg NEXT_PUBLIC_ENABLE_VENLY=${{ env.NEXT_PUBLIC_ENABLE_VENLY }} \
          --build-arg NEXT_PUBLIC_WEBBOT_NFT_SERVICE__BASE_URL=${{ env.NEXT_PUBLIC_WEBBOT_NFT_SERVICE__BASE_URL }} \
          --build-arg NEXT_PUBLIC_PDP_PAGE_ENABLED=${{ env.NEXT_PUBLIC_PDP_PAGE_ENABLED }} \
          --build-arg NEXT_PUBLIC_PAYMENT_URL=${{ env.NEXT_PUBLIC_PAYMENT_URL }} \
          -f packages/web-client-next/Dockerfile .
      
      - name: Push
        #working-directory: "packages/web-client-next"
        run: |
          docker push us-central1-docker.pkg.dev/${{ secrets.DEV_GCP_PROJECT_ID }}/unthink-ui-v2/unthink-ui-next-sammoon-ui-v2
      
      - name: Deploy
        #working-directory: "packages/web-client-next"
        run: |
          gcloud run deploy unthink-ui-next-sammoon-ui-v2 \
          --region us-central1 \
          --image us-central1-docker.pkg.dev/${{ secrets.DEV_GCP_PROJECT_ID }}/unthink-ui-v2/unthink-ui-next-sammoon-ui-v2 \
          --platform managed \
          --project ${{ secrets.DEV_GCP_PROJECT_ID }}
          
