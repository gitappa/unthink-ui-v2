# This is a basic workflow to help you get started with Actions
# unthink.shop

name: CI unthink shop stage
on:
  push:
    branches: 
      - stage
  workflow_dispatch:

jobs:
  build:
    name: Cloud Run Deployment Prod
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Use Node.js 12.x
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}
      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('package-lock.json') }}
      - name: Install Dependency
        working-directory: "packages/web-client-gatsby"
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm install
      - name: Setup and run build on app
        working-directory: "packages/web-client-gatsby"
        run: |
          npm run build
        env:
          NODE_OPTIONS: "--max_old_space_size=4096"
          #GATSBY_BACKEND_URL: "https://unthink-stage-backend-kjrgp3u4gq-uc.a.run.app"
          GATSBY_BACKEND_URL: "https://unthink-stage-backend-834750050334.us-central1.run.app"
          GATSBY_ACCESS_KEY: "efb3f14edb5b488bb4aed81a90a791e7"
          GA_TRACKING_ID: "G-909K3N1VM0"
          GATSBY_STAGING_ENV: "true"
          GATSBY_SUPER_ADMIN_USER_NAME: "fashiondemo"
          GATSBY_INSTANCE_LOGO: ""
          GATSBY_AURA_HEADER_THEME: "light"
          GATSBY_SHARED_PROFILE_ON_ROOT: "fashiondemo"
          GATSBY_CURRENT_STORE_NAME: "fashiondemo"
          GATSBY_HOME_PAGE_URL: ""
          GATSBY_CURRENT_STORE_ID: "87353109"
          GATSBY_ENABLE_VIEW_SIMILAR_PRODUCTS: "false"
          GATSBY_ENABLE_RECOMMENDATIONS: "false"
          GATSBY_IS_STORE_INSTANCE: "true"
          GATSBY_AURA_YFRET_USER_COLL_BASE_URL: "https://aurastage.unthink.ai"
          GATSBY_ENABLE_VENLY: "false"
          GATSBY_VENLY_ENVIRONMENT: "staging"
          # GATSBY_VENLY_CLIENT_ID: "unthink"
          GATSBY_WEBBOT_NFT_SERVICE__BASE_URL: ""
          #GATSBY_WEBBOT_NFT_SERVICE__BASE_URL: "https://webbot-nft-stage-qvde2butpa-uc.a.run.app"
          #GATSBY_WEBBOT_NFT_SERVICE__BASE_URL: "https://webbot-nft-stage-314035436999.us-central1.run.app"
          GATSBY_ENABLE_TRANSFER_NFT: "false"
          GATSBY_ADMIN_USER_ID: "170445147951739"
          GATSBY_PDP_PAGE_ENABLED: "true"
          GATSBY_PAYMENT_URL : "https://unthink-dropp-payment-prod-314035436999.us-central1.run.app"
      - name: Setup GCP Service Account
        uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: ${{ secrets.DEV_GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.DEV_GCP_SA_KEY_NEW}}
          export_default_credentials: true
      - name: Authorize
        working-directory: "packages/web-client-gatsby"
        run: |
          gcloud auth configure-docker us-docker.pkg.dev --quiet
      - name: Build
        working-directory: "packages/web-client-gatsby"
        #run: |
          #gcloud builds submit --tag gcr.io/${{ secrets.DEV_GCP_PROJECT_ID }}/unthink-ui-gatsby-unthink-stage
        run: |
          docker build --tag us-docker.pkg.dev/${{ secrets.DEV_GCP_PROJECT_ID }}/gcr.io/unthink-ui-gatsby-unthink-stage .
      - name: Push
        working-directory: "packages/web-client-gatsby"
        run: |
          docker push us-docker.pkg.dev/${{ secrets.DEV_GCP_PROJECT_ID }}/gcr.io/unthink-ui-gatsby-unthink-stage
      - name: Deploy
        working-directory: "packages/web-client-gatsby"
        run: |
          gcloud run deploy unthink-ui-gatsby-unthink-stage \
          --region us-central1 \
          --image us-docker.pkg.dev/${{ secrets.DEV_GCP_PROJECT_ID }}/gcr.io/unthink-ui-gatsby-unthink-stage \
          --platform managed \
          --project ${{ secrets.DEV_GCP_PROJECT_ID }}