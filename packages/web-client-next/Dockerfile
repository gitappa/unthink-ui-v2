# Use Node.js to build the Next.js app first
FROM node:18-alpine AS builder
WORKDIR /app

# Accept build arguments for environment variables
ARG NEXT_PUBLIC_BACKEND_URL
ARG NEXT_PUBLIC_ACCESS_KEY
ARG NEXT_PUBLIC_STAGING_ENV
ARG NEXT_PUBLIC_IS_KIOSK_ENABLED
ARG NEXT_PUBLIC_SUPER_ADMIN_USER_NAME
ARG NEXT_PUBLIC_AURA_HEADER_THEME
ARG NEXT_PUBLIC_SHARED_PROFILE_ON_ROOT
ARG NEXT_PUBLIC_CURRENT_STORE_NAME
ARG NEXT_PUBLIC_CURRENT_STORE_ID
ARG NEXT_PUBLIC_ENABLE_VIEW_SIMILAR_PRODUCTS
ARG NEXT_PUBLIC_ENABLE_RECOMMENDATIONS
ARG NEXT_PUBLIC_IS_STORE_INSTANCE
ARG NEXT_PUBLIC_ADMIN_USER_ID
ARG NEXT_PUBLIC_AURA_YFRET_USER_COLL_BASE_URL
ARG NEXT_PUBLIC_ENABLE_VENLY
ARG NEXT_PUBLIC_WEBBOT_NFT_SERVICE__BASE_URL
ARG NEXT_PUBLIC_PDP_PAGE_ENABLED
ARG NEXT_PUBLIC_PAYMENT_URL

# Set environment variables from build arguments
ENV NEXT_PUBLIC_BACKEND_URL=$NEXT_PUBLIC_BACKEND_URL
ENV NEXT_PUBLIC_ACCESS_KEY=$NEXT_PUBLIC_ACCESS_KEY
ENV NEXT_PUBLIC_STAGING_ENV=$NEXT_PUBLIC_STAGING_ENV
ENV NEXT_PUBLIC_IS_KIOSK_ENABLED=$NEXT_PUBLIC_IS_KIOSK_ENABLED
ENV NEXT_PUBLIC_SUPER_ADMIN_USER_NAME=$NEXT_PUBLIC_SUPER_ADMIN_USER_NAME
ENV NEXT_PUBLIC_AURA_HEADER_THEME=$NEXT_PUBLIC_AURA_HEADER_THEME
ENV NEXT_PUBLIC_SHARED_PROFILE_ON_ROOT=$NEXT_PUBLIC_SHARED_PROFILE_ON_ROOT
ENV NEXT_PUBLIC_CURRENT_STORE_NAME=$NEXT_PUBLIC_CURRENT_STORE_NAME
ENV NEXT_PUBLIC_CURRENT_STORE_ID=$NEXT_PUBLIC_CURRENT_STORE_ID
ENV NEXT_PUBLIC_ENABLE_VIEW_SIMILAR_PRODUCTS=$NEXT_PUBLIC_ENABLE_VIEW_SIMILAR_PRODUCTS
ENV NEXT_PUBLIC_ENABLE_RECOMMENDATIONS=$NEXT_PUBLIC_ENABLE_RECOMMENDATIONS
ENV NEXT_PUBLIC_IS_STORE_INSTANCE=$NEXT_PUBLIC_IS_STORE_INSTANCE
ENV NEXT_PUBLIC_ADMIN_USER_ID=$NEXT_PUBLIC_ADMIN_USER_ID
ENV NEXT_PUBLIC_AURA_YFRET_USER_COLL_BASE_URL=$NEXT_PUBLIC_AURA_YFRET_USER_COLL_BASE_URL
ENV NEXT_PUBLIC_ENABLE_VENLY=$NEXT_PUBLIC_ENABLE_VENLY
ENV NEXT_PUBLIC_WEBBOT_NFT_SERVICE__BASE_URL=$NEXT_PUBLIC_WEBBOT_NFT_SERVICE__BASE_URL
ENV NEXT_PUBLIC_PDP_PAGE_ENABLED=$NEXT_PUBLIC_PDP_PAGE_ENABLED
ENV NEXT_PUBLIC_PAYMENT_URL=$NEXT_PUBLIC_PAYMENT_URL

COPY packages/web-client-next/package*.json ./
RUN npm ci --legacy-peer-deps
COPY packages/web-client-next/ .
RUN npm run build

#### Production server environment
FROM node:18-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
# Do not hardcode PORT: Cloud Run sets the `PORT` env var at runtime.

# Copy the standalone Next.js server
COPY --from=builder /app/.next/standalone ./

# Copy static assets and CSS (Next.js compiled CSS is in .next/static)
COPY --from=builder /app/.next/static ./.next/static

# Copy public directory (static files like images)
COPY --from=builder /app/public ./public

# Copy package.json for reference
COPY --from=builder /app/package*.json ./

EXPOSE 3000
CMD ["node", "server.js"]